@page "/checkout"
@using PizzaStore.Models
@inject PizzaStore.Services.OrderState OrderState
@inject HttpClient Http
@inject NavigationManager NavManager

<h2>Review Your Order</h2>

<a class="back-link" href="/pizzas">
    <span class="arrow">‚Üê</span>
    <span>Back to menu</span>
</a>

@if (OrderState.Order == null || !OrderState.Order.Pizzas.Any())
{
    <div class="card">
        <p>No items in order. <a href="/pizzas">Order some pizza</a></p>
    </div>
}
else
{
    <div class="card checkout-card">
        <h4>Your Pizzas</h4>

        @for (int i = 0; i < OrderState.Order.Pizzas.Count; i++)
        {
            var pizza = OrderState.Order.Pizzas[i];
            <div class="checkout-item">
                <div class="item-details">
                    <div class="pizza-title">@pizza.Special?.Name</div>
                    <div class="item-specs">
                        <span class="spec">üìè @pizza.GetSizeDisplayName()</span>
                        @if (pizza.Toppings.Any())
                        {
                            <span class="spec">üßÖ @string.Join(", ", pizza.Toppings.Select(pt => pt.Topping?.Name))</span>
                        }
                    </div>
                    <div class="item-price">¬£@pizza.GetFormattedTotalPrice()</div>
                </div>
                <button class="btn btn-danger" @onclick="() => RemovePizza(i)">Remove</button>
            </div>
        }

        <div class="order-summary">
            <div class="summary-row">
                <span>Items:</span>
                <span>@OrderState.Order.Pizzas.Count</span>
            </div>
            <div class="summary-row total">
                <span>Total:</span>
                <span>¬£@OrderState.Order.GetTotalPriceString()</span>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div
                style="background:#fee; border:1px solid #fcc; border-radius:8px; padding:12px; margin-bottom:12px; color:#c00;">
                <strong>Error:</strong> @errorMessage
            </div>
        }

        <div style="display:flex; gap:8px; margin-top:16px; flex-wrap: wrap;">
            <button class="btn btn-warning" @onclick="PlaceOrder" disabled="@(isSubmitting || !OrderState.HasItems)">
                @if (isSubmitting)
                {
                    <span>‚è≥ Placing order...</span>
                }
                else
                {

                    <span>‚úì Place order</span>
                }
            </button>

            <button class="btn small-action" @onclick='() => NavManager.NavigateTo("/pizzas")'
                disabled="@isSubmitting">Continue Shopping</button>
        </div>
    </div>
}

@code {
    bool isSubmitting = false;
    string errorMessage = "";

    void RemovePizza(int index)
    {
        OrderState.RemovePizzaAt(index);
        StateHasChanged();
    }

    async Task PlaceOrder()
    {
        if (OrderState.Order == null || !OrderState.Order.Pizzas.Any())
        {
            errorMessage = "No items in order";
            return;
        }

        isSubmitting = true;
        errorMessage = "";

        try
        {
            // Create a copy of the order data to send
            var orderData = new
            {
                OrderState.Order.CreatedTime,
                Pizzas = OrderState.Order.Pizzas
            };

            var response = await Http.PostAsJsonAsync("api/orders", OrderState.Order);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Failed to place order: {response.StatusCode}";
                isSubmitting = false;
                StateHasChanged();
                return;
            }

            var newOrderId = await response.Content.ReadFromJsonAsync<int>();
            OrderState.ResetOrder();

            // Navigate to the order detail page
            NavManager.NavigateTo($"/myorders/{newOrderId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error placing order: {ex.Message}";
            isSubmitting = false;
            StateHasChanged();
        }
    }
}