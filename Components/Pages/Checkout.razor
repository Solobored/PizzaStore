@page "/checkout"
@inject PizzaStore.Services.OrderState OrderState
@inject HttpClient Http
@inject NavigationManager NavManager

<h2>Checkout</h2>

<a class="back-link" href="/pizzas">
    <span class="arrow">←</span>
    <span>Back to menu</span>
</a>

@if (OrderState.Order == null || !OrderState.Order.Pizzas.Any())
{
    <div class="card">
        <p>No items in order. <a href="/pizzas">Order some pizza</a></p>
    </div>
}
else
{
    <div class="card checkout-card">
        <h4>Review order</h4>

        @for (int i = 0; i < OrderState.Order.Pizzas.Count; i++)
        {
            var pizza = OrderState.Order.Pizzas[i];
            <div class="list-group-item">
                <div>
                    <div class="pizza-title">@pizza.Special?.Name</div>
                    <div class="pizza-price">@(pizza.Size)"" • £@pizza.GetFormattedTotalPrice()</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-danger" @onclick="() => RemovePizza(i)">Remove</button>
                </div>
            </div>
        }

        <p style="margin-top:16px; font-weight: 600; font-size: 1.1rem;">Total: £@OrderState.Order.GetTotalPriceString()</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background:#fee; border:1px solid #fcc; border-radius:8px; padding:12px; margin-bottom:12px; color:#c00;">
                <strong>Error:</strong> @errorMessage
            </div>
        }

        <div style="display:flex; gap:8px; margin-top:16px; flex-wrap: wrap;">
            <button class="btn btn-warning" @onclick="PlaceOrder" disabled="@(isSubmitting || !OrderState.HasItems)">
                @if (isSubmitting) { <span>⏳ Placing order...</span> } else { <span>✓ Place order</span> }
            </button>

            <button class="btn small-action" @onclick='() => NavManager.NavigateTo("/pizzas")' disabled="@isSubmitting">Continue Shopping</button>
        </div>
    </div>
}

@code {
    bool isSubmitting = false;
    string errorMessage = "";

    void RemovePizza(int index)
    {
        OrderState.RemovePizzaAt(index);
        StateHasChanged();
    }

    async Task PlaceOrder()
    {
        if (OrderState.Order == null || !OrderState.Order.Pizzas.Any())
        {
            errorMessage = "No items in order";
            return;
        }

        isSubmitting = true;
        errorMessage = "";

        try
        {
            // Create a copy of the order data to send
            var orderData = new
            {
                OrderState.Order.CreatedTime,
                Pizzas = OrderState.Order.Pizzas
            };

            var response = await Http.PostAsJsonAsync("api/orders", OrderState.Order);
            
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Failed to place order: {response.StatusCode}";
                isSubmitting = false;
                StateHasChanged();
                return;
            }

            var newOrderId = await response.Content.ReadFromJsonAsync<int>();
            OrderState.ResetOrder();
            
            // Navigate to the order detail page
            NavManager.NavigateTo($"/myorders/{newOrderId}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error placing order: {ex.Message}";
            isSubmitting = false;
            StateHasChanged();
        }
    }
}
