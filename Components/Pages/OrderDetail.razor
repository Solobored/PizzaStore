@page "/myorders/{OrderId:int}"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject IJSRuntime JS

<h2>Order detail</h2>

<a class="back-link" href="/myorders">
    <span class="arrow">‚Üê</span>
    <span>Back to orders</span>
</a>

@if (invalidOrder)
{
    <div class="card">
        <h3>Order not found</h3>
        <p>We're sorry but this order no longer exists.</p>
    </div>
}
else if (orderWithStatus == null)
{
    <p>Loading...</p>
}
else
{
    <div class="card checkout-card">
        <h4>Order placed @orderWithStatus.Order.CreatedTime.ToLongDateString()</h4>
        <div style="margin-bottom: 16px; padding: 12px; background: rgba(233,78,27,0.08); border-radius: 8px; border-left: 4px solid var(--accent);">
            <strong style="color: var(--accent);">Status: @orderWithStatus.StatusText</strong>
        </div>

        <div style="margin-bottom: 16px;">
            @foreach (var pizza in orderWithStatus.Order.Pizzas)
            {
                <div class="list-group-item" style="margin-bottom: 8px;">
                    <div>
                        <div class="pizza-title">@(pizza.Size)"" @pizza.Special?.Name</div>
                        <div class="pizza-price">¬£@pizza.GetFormattedTotalPrice()</div>
                    </div>
                </div>
            }
        </div>

        <div style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; font-weight: 600; text-align: right;">
            Total: ¬£@orderWithStatus.Order.GetTotalPriceString()
        </div>

        <div style="margin-top:20px; display:flex; gap:8px; flex-wrap: wrap;">
            <button class="btn btn-danger" @onclick="DeleteOrder">üóëÔ∏è Delete order</button>
            <button class="btn small-action" @onclick='() => NavManager.NavigateTo("/pizzas")'>üçï Order More</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    OrderWithStatus? orderWithStatus;
    bool invalidOrder = false;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            orderWithStatus = await Http.GetFromJsonAsync<OrderWithStatus>($"api/orders/{OrderId}");
            if (orderWithStatus == null) invalidOrder = true;
        }
        catch
        {
            invalidOrder = true;
        }
    }

    async Task DeleteOrder()
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete order {OrderId}? This cannot be undone.");
        if (!ok) return;

        var resp = await Http.DeleteAsync($"api/orders/{OrderId}");
        if (resp.IsSuccessStatusCode)
        {
            NavManager.NavigateTo("/myorders");
        }
        else
        {
            var msg = await resp.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Delete failed: {resp.StatusCode}\n{msg}");
        }
    }
}

